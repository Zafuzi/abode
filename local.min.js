let mousedown=!1,mx=0,my=0,mouse_click={x:0,y:0},canvas=document.querySelector("#game_canvas"),ctx=canvas.getContext("2d");canvas.width=window.innerWidth,canvas.height=window.innerHeight,ctx.font="18px sans-serif";let node_colors={power:"#fff3a6",oxygen:"#ffa6a6",methane:"#a6fffe",water:"#a6caff",steel:"#d3d7de",grass:"#a6ffaf",mouse:"red"},connections=[],factories=[];class Factory{constructor(e,t,n,a,o,c){this.name=e,this.x=t,this.y=n,this.inputs=a,this.outputs=o,this.color=c,this.w=250;let i=Object.keys(a).length>Object.keys(o).length?Object.keys(a).length:Object.keys(o).length;this.h=45+33*i,this.canvas=document.createElement("canvas"),this.canvas.width=this.w+35,this.canvas.height=this.h+3,this.ctx=this.canvas.getContext("2d"),this.ctx.font="18px sans-serif",this.ctx.imageSmoothingEnabled=!0}init(){let e=this,t=15,n=57;e.ctx.clearRect(0,0,e.canvas.w,e.canvas.h),e.ctx.beginPath(),e.ctx.fillStyle="#333",e.ctx.fillRect(t,0,e.w,e.h),e.ctx.strokeStyle="#ddd",e.ctx.lineWidth=2,e.ctx.strokeRect(t,0,e.w,e.h),e.ctx.closePath(),Object.keys(e.inputs).forEach(a=>{let o=e.inputs[a];console.log(e.name," | input:",a),o.x=t,o.y=n,o.name=a,o.parent=e,e.ctx.beginPath(),e.ctx.fillStyle=node_colors[o.name],e.ctx.arc(o.x,o.y,10,0,2*Math.PI),e.ctx.fill(),e.ctx.closePath(),e.ctx.beginPath(),e.ctx.fillText(o.name,o.x+18,o.y+5),e.ctx.closePath(),n+=25}),t=15+e.w,n=23,Object.keys(e.outputs).forEach(a=>{console.log(e.name," | output:",a);let o=e.outputs[a];o.x=t,o.y=n,o.name=a,o.parent=e,e.ctx.beginPath(),e.ctx.fillStyle=node_colors[o.name],e.ctx.arc(o.x,o.y,10,0,2*Math.PI),e.ctx.fill(),e.ctx.closePath(),e.ctx.beginPath(),e.ctx.fillText(o.name,o.x-e.ctx.measureText(o.name).width-18,o.y+5),e.ctx.closePath(),n+=25}),e.ctx.beginPath(),e.ctx.fillStyle="#fff",e.ctx.fillText(e.name,24,27),e.ctx.closePath(),console.log(""),factories.push(e)}update(){this.connections=[],this.calc_connections()}calc_connections(){let e=this,t=15+e.w,n=23;Object.keys(e.outputs).forEach(a=>{let o=e.outputs[a];if(o.x=t,o.y=n,o.name=a,o.parent=e,o.connected){let t=o.connected;if(t.remove_on_mouse_up&&!mousedown)return o.connected=null,void factories.forEach(e=>{Object.keys(e.inputs).forEach(n=>{let a=e.inputs[n];hit_rad({x:a.x+e.x,y:a.y+e.y,r:10})&&n==t.name&&(o.connected=a)})});if(!t.parent)return;let n={},a=e.x+o.x>t.x+t.parent.x?t:o;n.remote_node=t,n.parent=e;let i=(e.x+o.x+t.parent.x+t.x)/2;if(o==a){let a={x:i,y:o.y+e.y},c={x:i,y:t.parent.y+t.y};n.x=o.x,n.y=o.y,n.cp1=a,n.cp2=c,n.px=t.x,n.py=t.y}else{let a={x:i,y:t.parent.y+t.y},c={x:i,y:e.y+o.y};n.x=o.x,n.y=o.y,n.cp1=a,n.cp2=c,n.px=t.x,n.py=t.y}var c=ctx.createLinearGradient(o.x,o.y,t.x,t.y);c.addColorStop(0,node_colors[o.name]),c.addColorStop(1,node_colors[t.name]),n.strokeStyle=c,e.connections.push(n)}n+=25})}}let SolarPanel=new Factory("Solar Panel",100,300,{},{power:{}},"#333");SolarPanel.init();let OxygenMine=new Factory("Oxygen Mine",400,300,{power:{},water:{}},{oxygen:{}},"#333");OxygenMine.init();let RainCollector=new Factory("Rain Collector",100,400,{},{water:{}},"#333");RainCollector.init();let GrassField=new Factory("GrassField",100,500,{},{grass:{}},"#333");GrassField.init();let MethaneMine=new Factory("Farting Cows",400,450,{grass:{},water:{}},{methane:{}},"#333");MethaneMine.init();let SteelMine=new Factory("Steel Mine",800,250,{oxygen:{},methane:{}},{steel:{}},"#333");SteelMine.init();let dragging,then=performance.now(),FPS=120,t=0,FPS_LOCK=function(){let e=performance.now(),t=e-then;t>1e3/FPS?(then=e-t%(1e3/FPS),loop()):requestAnimationFrame(FPS_LOCK)},hit=function(e=Factory){let t=e.x,n=e.y;e.w,e.h;return!(mx<t)&&(!(mx>t+e.w)&&(!(my<n)&&!(my>n+e.h)))},hit_rad=function(e){let t=10,n=t*e.r+e.r*e.r,a=Math.abs(e.x-mx),o=Math.abs(e.y-my),c=a*a+o*o;return c<n};ctx.imageSmoothingEnabled=!0;let grid_size=50,loop=function(){if(t++,ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),connections=[],factories.forEach(e=>{e.update(),e.connections.forEach(e=>{ctx.beginPath(),ctx.moveTo(e.parent.x+e.x,e.parent.y+e.y),ctx.bezierCurveTo(e.cp1.x,e.cp1.y,e.cp2.x,e.cp2.y,e.remote_node.parent.x+e.px,e.remote_node.parent.y+e.py),ctx.strokeStyle=e.strokeStyle,ctx.stroke(),ctx.closePath()})}),factories.forEach(e=>{ctx.drawImage(e.canvas,e.x,e.y)}),mousedown)if(dragging)dragging.name?(dragging.x=mx,dragging.y=my):(dragging.f.x=Math.round((mx-dragging.diffx)/grid_size)*grid_size,dragging.f.y=Math.round((my-dragging.diffy)/grid_size)*grid_size);else for(let e=0;e<factories.length;e++){let t=factories[e];hit(t)&&(dragging={f:t,diffx:mx-t.x,diffy:my-t.y}),Object.keys(t.outputs).forEach(e=>{let n=t.outputs[e];if(hit_rad({x:n.x+t.x,y:n.y+t.y,r:10})){let a={remove_on_mouse_up:!0,name:n.name,x:mx-n.x,y:my-n.y,parent:{name:"mouse",x:0,y:0}};t.outputs[e].connected=a,dragging=a}})}requestAnimationFrame(FPS_LOCK)};requestAnimationFrame(FPS_LOCK),addEventListener("mousedown",e=>{mousedown=!0,mouse_click.x=e.pageX,mouse_click.y=e.pageY}),addEventListener("mouseup",e=>{mousedown=!1,dragging=!1}),addEventListener("mousemove",e=>{mx=e.pageX,my=e.pageY});