function d2r(t){return t*(Math.PI/180)}function hit_poly(t){for(var e=!1,a=mx,r=my,n=0;n<t.length-1;n++){var s=t[n][0],o=t[n][1],c=t[n+1][0],i=t[n+1][1];(o<r&&i>=r||i<r&&o>=r)&&s+(r-o)/(i-o)*(c-s)<a&&(e=!e)}return e}function trackTransforms(t){var e=document.createElementNS("http://www.w3.org/2000/svg","svg"),a=e.createSVGMatrix();t.getTransform=function(){return a};var r=[],n=t.save;t.save=function(){return r.push(a.translate(0,0)),n.call(t)};var s=t.restore;t.restore=function(){return a=r.pop(),s.call(t)};var o=t.scale;t.scale=function(e,r){return a=a.scaleNonUniform(e,r),o.call(t,e,r)};var c=t.rotate;t.rotate=function(e){return a=a.rotate(180*e/Math.PI),c.call(t,e)};var i=t.translate;t.translate=function(e,r){return a=a.translate(e,r),i.call(t,e,r)};var d=t.transform;t.transform=function(r,n,s,o,c,i){var l=e.createSVGMatrix();return l.a=r,l.b=n,l.c=s,l.d=o,l.e=c,l.f=i,a=a.multiply(l),d.call(t,r,n,s,o,c,i)};var l=t.setTransform;t.setTransform=function(e,r,n,s,o,c){return a.a=e,a.b=r,a.c=n,a.d=s,a.e=o,a.f=c,l.call(t,e,r,n,s,o,c)};var m=e.createSVGPoint();t.transformedPoint=function(t,e){return m.x=t,m.y=e,m.matrixTransform(a.inverse())}}let mousedown=!1,rightmousedown=!1,middlemousedown=!1,mx=0,my=0,static_mx=0,static_my=0,mouse_click={x:0,y:0},lastX=0,lastY=0,dragStart=null,dragged=!1,scaleFactor=1.025,canvas=document.querySelector("#game_canvas"),ctx=canvas.getContext("2d");ctx.imageSmoothingEnabled=!0,ctx.lineWidth=3,canvas.width=window.innerWidth,canvas.height=window.innerHeight,trackTransforms(ctx),lastX=canvas.width/2,lastY=canvas.height/2;let dragging,connections=[],factories=[],grid_size=10,font_size=18,then=performance.now(),FPS=120,t=0,scale=1;new Factory(FactoryTypes.steel,800,400),new Factory(FactoryTypes.iron,500,300),new Factory(FactoryTypes.carbon,500,500),new Factory(FactoryTypes.oxygen,500,600),new Factory(FactoryTypes.solar,60,500),new Factory(FactoryTypes.water,60,600),new Factory(FactoryTypes.rocket,1100,300),new Factory(FactoryTypes.trees,100,100);let loop=function(){t++;var e=ctx.transformedPoint(0,0),a=ctx.transformedPoint(canvas.width,canvas.height);if(ctx.clearRect(e.x,e.y,a.x-e.x,a.y-e.y),ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#1e1e1e",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.restore(),factories.forEach(t=>{t.update(),t.connections.forEach(t=>{ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.bezierCurveTo(t.cp1.x,t.cp1.y,t.cp2.x,t.cp2.y,t.px,t.py),ctx.strokeStyle=t.strokeStyle,ctx.stroke(),ctx.closePath()})}),factories.forEach(t=>{t.draw()}),mousedown)if(dragging)dragging.name?(dragging.x=mx,dragging.y=my):(dragging.f.x=Math.round((mx-dragging.diffx)/grid_size)*grid_size,dragging.f.y=Math.round((my-dragging.diffy)/grid_size)*grid_size);else for(let t=0;t<factories.length;t++){let e=factories[t];hit(e)&&(dragging={f:e,diffx:mx-e.x,diffy:my-e.y}),Object.keys(e.outputs).forEach(t=>{let a=e.outputs[t];if(hit_rad({x:a.x,y:a.y,r:a.r})){let r={remove_on_mouse_up:!0,name:a.name,x:mx,y:my,parent:{name:"mouse",x:mx,y:my}};e.outputs[t].connected=r,dragging=r}})}ctx.save(),ctx.setTransform(1,0,0,1,0,0),rightmousedown&&(ctx.fillStyle="#5e5e5e",context_wheel.forEach((t,e)=>{t.update(),hit_poly(t.shape)?t.hovering=!0:t.hovering=!1,t.draw()}),ctx.beginPath(),ctx.moveTo(static_mx,static_my),ctx.fill(),ctx.closePath()),ctx.restore(),requestAnimationFrame(FPS_LOCK)},wheel_radius=75,wheel_inner_radius=25,context_wheel=[],d=60;for(let t=0;t<360/d;t++)context_wheel.push({name:"add",deg:d,hovering:!1,clicked:!1,shape:[],update:function(){let e=this,a=e.deg/2,r=t*e.deg;e.shape=[[static_mx+Math.cos(d2r(r-a))*wheel_inner_radius,static_my+Math.sin(d2r(r-a))*wheel_inner_radius],[static_mx+Math.cos(d2r(r-a))*(wheel_radius+10),static_my+Math.sin(d2r(r-a))*(wheel_radius+10)],[static_mx+Math.cos(d2r(r+a))*(wheel_radius+10),static_my+Math.sin(d2r(r+a))*(wheel_radius+10)],[static_mx+Math.cos(d2r(r+a))*wheel_inner_radius,static_my+Math.sin(d2r(r+a))*wheel_inner_radius],[static_mx+Math.cos(d2r(r-a))*wheel_inner_radius,static_my+Math.sin(d2r(r-a))*wheel_inner_radius]]},draw:function(){let e=this,a=e.deg/2,r=t*e.deg;e.hovering?ctx.strokeStyle="#fff":ctx.strokeStyle="#5e5e5e",ctx.beginPath(),ctx.moveTo(static_mx+Math.cos(d2r(r-a))*wheel_inner_radius,static_my+Math.sin(d2r(r-a))*wheel_inner_radius),ctx.lineTo(static_mx+Math.cos(d2r(r-a))*wheel_radius,static_my+Math.sin(d2r(r-a))*wheel_radius),ctx.arc(static_mx+Math.cos(d2r(r+a)),static_my+Math.sin(d2r(r+a)),wheel_radius,d2r(r-a),d2r(r+a),!1),ctx.lineTo(static_mx+Math.cos(d2r(r+a))*wheel_inner_radius,static_my+Math.sin(d2r(r+a))*wheel_inner_radius),ctx.lineTo(static_mx+Math.cos(d2r(r-a))*wheel_inner_radius,static_my+Math.sin(d2r(r-a))*wheel_inner_radius),ctx.stroke(),ctx.closePath()}});console.log(context_wheel),context_wheel.forEach(t=>{t.x=0,t.y=0});let FPS_LOCK=function(){let t=performance.now(),e=t-then;e>1e3/FPS?(then=t-e%(1e3/FPS),loop()):requestAnimationFrame(FPS_LOCK)};requestAnimationFrame(FPS_LOCK),addEventListener("contextmenu",t=>{t.preventDefault()}),addEventListener("mousedown",t=>{document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none";let e=t.button;switch(t.preventDefault(),mouse_click.x=t.pageX,mouse_click.y=t.pageY,e){case 0:mousedown=!0;break;case 1:middlemousedown=!0,lastX=t.offsetX||t.pageX-canvas.offsetLeft,lastY=t.offsetY||t.pageY-canvas.offsetTop,dragStart=ctx.transformedPoint(lastX,lastY),dragged=!1;break;case 2:rightmousedown=!0,static_mx=t.clientX,static_my=t.clientY;break;default:mousedown=!0,mouse_click.x=t.pageX,mouse_click.y=t.pageY}}),addEventListener("mouseup",t=>{let e=t.button;switch(t.preventDefault(),mousedown=!1,dragging=!1,e){case 0:mousedown=!1;break;case 1:middlemousedown=!1,dragStart=null;break;case 2:rightmousedown=!1,static_mx=t.clientX,static_my=t.clientY;break;default:mousedown=!1}}),addEventListener("mousemove",t=>{t.preventDefault(),t.stopPropagation();let e=ctx.transformedPoint(t.clientX,t.clientY);if(mx=e.x,my=e.y,middlemousedown&&(lastX=t.offsetX||t.pageX-canvas.offsetLeft,lastY=t.offsetY||t.pageY-canvas.offsetTop,dragged=!0,dragStart)){var a=ctx.transformedPoint(lastX,lastY);ctx.translate(a.x-dragStart.x,a.y-dragStart.y)}}),addEventListener("mouseout",t=>{t.preventDefault(),t.stopPropagation(),mousedown=!1,rightmousedown=!1,middlemousedown=!1,dragStart=null});let zoom=function(t){var e=ctx.transformedPoint(canvas.width/2,canvas.height/2);ctx.translate(e.x,e.y),scale=Math.pow(scaleFactor,t),ctx.scale(scale,scale),ctx.translate(-e.x,-e.y)};addEventListener("wheel",t=>{var e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;return e&&zoom(e),!1});let hit=function(t){let e=t.x,a=t.y;t.w,t.h;return!(mx<e)&&(!(mx>e+t.w)&&(!(my<a)&&!(my>a+t.h)))},hit_rad=function(t){let e=10,a=e*t.r+t.r*t.r,r=Math.abs(t.x-mx),n=Math.abs(t.y-my),s=r*r+n*n;return s<a};