function d2r(e){return e*(Math.PI/180)}function hit_poly(e){for(var t=!1,a=mx,r=my,n=0;n<e.length-1;n++){var s=e[n][0],o=e[n][1],i=e[n+1][0],c=e[n+1][1];(o<r&&c>=r||c<r&&o>=r)&&s+(r-o)/(c-o)*(i-s)<a&&(t=!t)}return t}function trackTransforms(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg"),a=t.createSVGMatrix();e.getTransform=function(){return a};var r=[],n=e.save;e.save=function(){return r.push(a.translate(0,0)),n.call(e)};var s=e.restore;e.restore=function(){return a=r.pop(),s.call(e)};var o=e.scale;e.scale=function(t,r){return a=a.scaleNonUniform(t,r),o.call(e,t,r)};var i=e.rotate;e.rotate=function(t){return a=a.rotate(180*t/Math.PI),i.call(e,t)};var c=e.translate;e.translate=function(t,r){return a=a.translate(t,r),c.call(e,t,r)};var d=e.transform;e.transform=function(r,n,s,o,i,c){var l=t.createSVGMatrix();return l.a=r,l.b=n,l.c=s,l.d=o,l.e=i,l.f=c,a=a.multiply(l),d.call(e,r,n,s,o,i,c)};var l=e.setTransform;e.setTransform=function(t,r,n,s,o,i){return a.a=t,a.b=r,a.c=n,a.d=s,a.e=o,a.f=i,l.call(e,t,r,n,s,o,i)};var m=t.createSVGPoint();e.transformedPoint=function(e,t){return m.x=e,m.y=t,m.matrixTransform(a.inverse())}}let mousedown=!1,rightmousedown=!1,middlemousedown=!1,mx=0,my=0,static_mx=0,static_my=0,mouse_click={x:0,y:0},lastX=0,lastY=0,dragStart=null,dragged=!1,scaleFactor=1.025,canvas=document.querySelector("#game_canvas"),ctx=canvas.getContext("2d");ctx.imageSmoothingEnabled=!1,ctx.lineWidth=3;let menu=document.querySelector("#add_menu");canvas.width=window.innerWidth,canvas.height=window.innerHeight,trackTransforms(ctx),lastX=canvas.width/2,lastY=canvas.height/2;let dragging,connections=[],factories=[],grid_size=10,font_size=18,then=performance.now(),FPS=120,t=0,scale=1,add_factory=function(e){console.log("click");var t=ctx.transformedPoint(canvas.width/2,canvas.height/2);new Factory(FactoryTypes[e],t.x,t.y)},noder=rplc8("#noder"),a=[];Object.keys(FactoryTypes).forEach(e=>{let t=clone(FactoryTypes[e]);t.type=e,a.push(t)}),noder.update(a);let loop=function(){t++;var e=ctx.transformedPoint(0,0),a=ctx.transformedPoint(canvas.width,canvas.height);if(ctx.clearRect(e.x,e.y,a.x-e.x,a.y-e.y),ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#1e1e1e",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.restore(),factories.forEach(e=>{e.update(),e.connections.forEach(e=>{ctx.beginPath(),ctx.moveTo(e.x,e.y),ctx.bezierCurveTo(e.cp1.x,e.cp1.y,e.cp2.x,e.cp2.y,e.px,e.py),ctx.strokeStyle=e.strokeStyle,ctx.stroke(),ctx.closePath()})}),factories.forEach(e=>{e.draw()}),mousedown)if(dragging)dragging.name?(dragging.x=mx,dragging.y=my):(dragging.f.x=Math.round((mx-dragging.diffx)/grid_size)*grid_size,dragging.f.y=Math.round((my-dragging.diffy)/grid_size)*grid_size);else for(let e=0;e<factories.length;e++){let t=factories[e];hit(t)&&(dragging={f:t,diffx:mx-t.x,diffy:my-t.y}),Object.keys(t.outputs).forEach(e=>{let a=t.outputs[e];if(hit_rad({x:a.x,y:a.y,r:a.r})){let r={remove_on_mouse_up:!0,name:a.name,x:mx,y:my,parent:{name:"mouse",x:mx,y:my}};t.outputs[e].connected=r,dragging=r}})}requestAnimationFrame(FPS_LOCK)},wheel_radius=75,wheel_inner_radius=25,context_wheel=[],d=60;for(let e=0;e<360/d;e++)context_wheel.push({name:"add",deg:d,hovering:!1,clicked:!1,shape:[],update:function(){let t=this,a=t.deg/2,r=e*t.deg;t.shape=[[static_mx+Math.cos(d2r(r-a))*wheel_inner_radius,static_my+Math.sin(d2r(r-a))*wheel_inner_radius],[static_mx+Math.cos(d2r(r-a))*(wheel_radius+10),static_my+Math.sin(d2r(r-a))*(wheel_radius+10)],[static_mx+Math.cos(d2r(r+a))*(wheel_radius+10),static_my+Math.sin(d2r(r+a))*(wheel_radius+10)],[static_mx+Math.cos(d2r(r+a))*wheel_inner_radius,static_my+Math.sin(d2r(r+a))*wheel_inner_radius],[static_mx+Math.cos(d2r(r-a))*wheel_inner_radius,static_my+Math.sin(d2r(r-a))*wheel_inner_radius]]},draw:function(){let t=this,a=t.deg/2,r=e*t.deg;t.hovering?ctx.strokeStyle="#fff":ctx.strokeStyle="#5e5e5e",ctx.beginPath(),ctx.moveTo(static_mx+Math.cos(d2r(r-a))*wheel_inner_radius,static_my+Math.sin(d2r(r-a))*wheel_inner_radius),ctx.lineTo(static_mx+Math.cos(d2r(r-a))*wheel_radius,static_my+Math.sin(d2r(r-a))*wheel_radius),ctx.arc(static_mx+Math.cos(d2r(r+a)),static_my+Math.sin(d2r(r+a)),wheel_radius,d2r(r-a),d2r(r+a),!1),ctx.lineTo(static_mx+Math.cos(d2r(r+a))*wheel_inner_radius,static_my+Math.sin(d2r(r+a))*wheel_inner_radius),ctx.lineTo(static_mx+Math.cos(d2r(r-a))*wheel_inner_radius,static_my+Math.sin(d2r(r-a))*wheel_inner_radius),ctx.stroke(),ctx.closePath()}});console.log(context_wheel),context_wheel.forEach(e=>{e.x=0,e.y=0});let FPS_LOCK=function(){let e=performance.now(),t=e-then;t>1e3/FPS?(then=e-t%(1e3/FPS),loop()):requestAnimationFrame(FPS_LOCK)};requestAnimationFrame(FPS_LOCK),addEventListener("contextmenu",e=>{e.preventDefault()}),addEventListener("mousedown",e=>{document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none";let t=e.button;switch(mouse_click.x=e.pageX,mouse_click.y=e.pageY,t){case 0:mousedown=!0,middlemousedown=!1,rightmousedown=!1;break;case 1:e.preventDefault(),middlemousedown=!0,mousedown=!1,rightmousedown=!1,lastX=e.offsetX||e.pageX-canvas.offsetLeft,lastY=e.offsetY||e.pageY-canvas.offsetTop,dragStart=ctx.transformedPoint(lastX,lastY),dragged=!1;break;case 2:e.preventDefault(),rightmousedown=!0,middlemousedown=!1,mousedown=!1,static_mx=e.clientX,static_my=e.clientY;break;default:mousedown=!0,mouse_click.x=e.pageX,mouse_click.y=e.pageY}}),addEventListener("mouseup",e=>{e.preventDefault(),dragging=!1,mousedown=!1,rightmousedown=!1,middlemousedown=!1}),addEventListener("mousemove",e=>{e.preventDefault(),e.stopPropagation();let t=ctx.transformedPoint(e.clientX,e.clientY);if(mx=t.x,my=t.y,middlemousedown&&(lastX=e.offsetX||e.pageX-canvas.offsetLeft,lastY=e.offsetY||e.pageY-canvas.offsetTop,dragged=!0,dragStart)){var a=ctx.transformedPoint(lastX,lastY);ctx.translate(a.x-dragStart.x,a.y-dragStart.y)}}),addEventListener("mouseout",e=>{e.preventDefault(),e.stopPropagation(),mousedown=!1,rightmousedown=!1,middlemousedown=!1,dragStart=null}),addEventListener("wheel",e=>{var t=e.wheelDelta?e.wheelDelta/40:e.detail?-e.detail:0;return t&&zoom(t),!1});let zoom=function(e){var t=ctx.transformedPoint(canvas.width/2,canvas.height/2);ctx.translate(t.x,t.y),scale=Math.pow(scaleFactor,e),ctx.scale(scale,scale),ctx.translate(-t.x,-t.y)},hit=function(e){let t=e.x,a=e.y;e.w,e.h;return!(mx<t)&&(!(mx>t+e.w)&&(!(my<a)&&!(my>a+e.h)))},hit_rad=function(e){let t=10,a=t*e.r+e.r*e.r,r=Math.abs(e.x-mx),n=Math.abs(e.y-my),s=r*r+n*n;return s<a};