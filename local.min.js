function trackTransforms(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg"),a=t.createSVGMatrix();e.getTransform=function(){return a};var r=[],n=e.save;e.save=function(){return r.push(a.translate(0,0)),n.call(e)};var o=e.restore;e.restore=function(){return a=r.pop(),o.call(e)};var s=e.scale;e.scale=function(t,r){return a=a.scaleNonUniform(t,r),s.call(e,t,r)};var c=e.rotate;e.rotate=function(t){return a=a.rotate(180*t/Math.PI),c.call(e,t)};var i=e.translate;e.translate=function(t,r){return a=a.translate(t,r),i.call(e,t,r)};var d=e.transform;e.transform=function(r,n,o,s,c,i){var l=t.createSVGMatrix();return l.a=r,l.b=n,l.c=o,l.d=s,l.e=c,l.f=i,a=a.multiply(l),d.call(e,r,n,o,s,c,i)};var l=e.setTransform;e.setTransform=function(t,r,n,o,s,c){return a.a=t,a.b=r,a.c=n,a.d=o,a.e=s,a.f=c,l.call(e,t,r,n,o,s,c)};var m=t.createSVGPoint();e.transformedPoint=function(e,t){return m.x=e,m.y=t,m.matrixTransform(a.inverse())}}let mousedown=!1,rightmousedown=!1,middlemousedown=!1,mx=0,my=0,mouse_click={x:0,y:0},lastX=0,lastY=0,dragStart=null,dragged=!1,scaleFactor=1.025,canvas=document.querySelector("#game_canvas"),ctx=canvas.getContext("2d");ctx.imageSmoothingEnabled=!0,ctx.lineWidth=3,canvas.width=window.innerWidth,canvas.height=window.innerHeight,trackTransforms(ctx),lastX=canvas.width/2,lastY=canvas.height/2;let dragging,connections=[],factories=[],grid_size=2,font_size=18,then=performance.now(),FPS=120,t=0;new Factory(FactoryTypes.steel,600,400),new Factory(FactoryTypes.iron,400,300),new Factory(FactoryTypes.carbon,400,450),new Factory(FactoryTypes.oxygen,400,550),new Factory(FactoryTypes.solar,50,450),new Factory(FactoryTypes.water,50,550),new Factory(FactoryTypes.rocket,1100,300),new Factory(FactoryTypes.trees,100,100);let loop=function(){t++;var e=ctx.transformedPoint(0,0),a=ctx.transformedPoint(canvas.width,canvas.height);if(ctx.clearRect(e.x,e.y,a.x-e.x,a.y-e.y),ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.restore(),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),factories.forEach(e=>{e.update(),e.connections.forEach(e=>{ctx.beginPath(),ctx.moveTo(e.x,e.y),ctx.bezierCurveTo(e.cp1.x,e.cp1.y,e.cp2.x,e.cp2.y,e.px,e.py),ctx.strokeStyle=e.strokeStyle,ctx.stroke(),ctx.closePath()})}),factories.forEach(e=>{e.draw()}),mousedown)if(dragging)dragging.name?(dragging.x=mx,dragging.y=my):(dragging.f.x=Math.round((mx-dragging.diffx)/grid_size)*grid_size,dragging.f.y=Math.round((my-dragging.diffy)/grid_size)*grid_size);else for(let e=0;e<factories.length;e++){let t=factories[e];hit(t)&&(dragging={f:t,diffx:mx-t.x,diffy:my-t.y}),Object.keys(t.outputs).forEach(e=>{let a=t.outputs[e];if(hit_rad({x:a.x,y:a.y,r:a.r})){let r={remove_on_mouse_up:!0,name:a.name,x:mx,y:my,parent:{name:"mouse",x:mx,y:my}};t.outputs[e].connected=r,dragging=r}})}requestAnimationFrame(FPS_LOCK)},FPS_LOCK=function(){let e=performance.now(),t=e-then;t>1e3/FPS?(then=e-t%(1e3/FPS),loop()):requestAnimationFrame(FPS_LOCK)};requestAnimationFrame(FPS_LOCK),addEventListener("contextmenu",e=>{e.preventDefault()}),addEventListener("mousedown",e=>{document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none";let t=e.button;switch(e.preventDefault(),mouse_click.x=e.pageX,mouse_click.y=e.pageY,t){case 0:mousedown=!0;break;case 1:middlemousedown=!0,lastX=e.offsetX||e.pageX-canvas.offsetLeft,lastY=e.offsetY||e.pageY-canvas.offsetTop,dragStart=ctx.transformedPoint(lastX,lastY),dragged=!1;break;case 2:rightmousedown=!0;break;default:mousedown=!0,mouse_click.x=e.pageX,mouse_click.y=e.pageY}}),addEventListener("mouseup",e=>{let t=e.button;switch(e.preventDefault(),mousedown=!1,dragging=!1,t){case 0:mousedown=!1;break;case 1:middlemousedown=!1,dragStart=null;break;case 2:rightmousedown=!1;break;default:mousedown=!1}}),addEventListener("mousemove",e=>{e.preventDefault(),e.stopPropagation();let t=ctx.transformedPoint(e.clientX,e.clientY);if(mx=t.x,my=t.y,middlemousedown&&(lastX=e.offsetX||e.pageX-canvas.offsetLeft,lastY=e.offsetY||e.pageY-canvas.offsetTop,dragged=!0,dragStart)){var a=ctx.transformedPoint(lastX,lastY);ctx.translate(a.x-dragStart.x,a.y-dragStart.y)}}),addEventListener("mouseout",e=>{e.preventDefault(),e.stopPropagation(),mousedown=!1,rightmousedown=!1,middlemousedown=!1,dragStart=null});let zoom=function(e){var t=ctx.transformedPoint(canvas.width/2,canvas.height/2);ctx.translate(t.x,t.y);var a=Math.pow(scaleFactor,e);ctx.scale(a,a),ctx.translate(-t.x,-t.y)};zoom(25),addEventListener("wheel",e=>{var t=e.wheelDelta?e.wheelDelta/40:e.detail?-e.detail:0;return t&&zoom(t),!1});let hit=function(e=Factory){let t=e.x,a=e.y;e.w,e.h;return!(mx<t)&&(!(mx>t+e.w)&&(!(my<a)&&!(my>a+e.h)))},hit_rad=function(e){let t=10,a=t*e.r+e.r*e.r,r=Math.abs(e.x-mx),n=Math.abs(e.y-my),o=r*r+n*n;return o<a};