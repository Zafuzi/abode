function d2r(e){return e*(Math.PI/180)}function hit_poly(e){for(var t=!1,a=mx,n=my,o=0;o<e.length-1;o++){var r=e[o][0],c=e[o][1],i=e[o+1][0],s=e[o+1][1];(c<n&&s>=n||s<n&&c>=n)&&r+(n-c)/(s-c)*(i-r)<a&&(t=!t)}return t}function trackTransforms(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg"),a=t.createSVGMatrix();e.getTransform=function(){return a};var n=[],o=e.save;e.save=function(){return n.push(a.translate(0,0)),o.call(e)};var r=e.restore;e.restore=function(){return a=n.pop(),r.call(e)};var c=e.scale;e.scale=function(t,n){return a=a.scaleNonUniform(t,n),c.call(e,t,n)};var i=e.rotate;e.rotate=function(t){return a=a.rotate(180*t/Math.PI),i.call(e,t)};var s=e.translate;e.translate=function(t,n){return a=a.translate(t,n),s.call(e,t,n)};var d=e.transform;e.transform=function(n,o,r,c,i,s){var l=t.createSVGMatrix();return l.a=n,l.b=o,l.c=r,l.d=c,l.e=i,l.f=s,a=a.multiply(l),d.call(e,n,o,r,c,i,s)};var l=e.setTransform;e.setTransform=function(t,n,o,r,c,i){return a.a=t,a.b=n,a.c=o,a.d=r,a.e=c,a.f=i,l.call(e,t,n,o,r,c,i)};var u=t.createSVGPoint();e.transformedPoint=function(e,t){return u.x=e,u.y=t,u.matrixTransform(a.inverse())}}let mousedown=!1,rightmousedown=!1,middlemousedown=!1,mx=0,my=0,static_mx=0,static_my=0,mouse_click={x:0,y:0},lastX=0,lastY=0,dragStart=null,dragged=!1,scaleFactor=1.025,canvas=document.querySelector("#game_canvas"),ctx=canvas.getContext("2d");ctx.imageSmoothingEnabled=!1,ctx.lineWidth=3;let menu=document.querySelector("#add_menu");canvas.width=window.innerWidth,canvas.height=window.innerHeight,trackTransforms(ctx),lastX=canvas.width/2,lastY=canvas.height/2;let dragging,grid_size=1,font_size=18,then=performance.now(),FPS=120,t=0,scale=1,Icons={credit:"images/tile.png",steel:"images/steel.png",oxygen:"images/oxygen.png",methane:"images/methane.png",rocket:"images/rocket.png",station:"images/station.png",power:"images/power.png",solar:"images/power.png",hydrogen:"images/tile.png",water:"images/water.png",carbon:"images/carbon.png",grass:"images/tile.png",iron:"images/iron.png",slag:"images/tile.png",trees:"images/trees.png",silicate:"images/tile.png",factory:"images/factory.png",tank:"images/tile.png",tile:"images/tile.png",splitter:"images/tile.png",combiner:"images/tile.png"},node_colors={any:"#fff",power:"#fff3a6",solar:"#fff3a6",oxygen:"#ffa6a6",hydrogen:"#fff",methane:"#a6fffe",water:"#a6caff",steel:"#999",grass:"#a6ffaf",carbon:"#58637a",slag:"#c9bbab",iron:"#ba7254",rocket:"#ff99e6",silicates:"#b6c9a5",trees:"#2E6230",carbon_dioxide:"#ffffff",food:"#ffffff",tile:"pink"},rates={solar:{power:{production_rate:20}},water_pump:{power:{usage_rate:10},water:{production_rate:100}},combiner:{any:{usage_rate:0,production_rate:0}}},factories=[],factory_font_size=24,factory_icon_size=24,factory_padding=5,factory_font=factory_font_size+"px monospace",factory=function(e="empty",t="Empty and Useless",a=Icons.tile,n=[],o=[],r=100,c=100){let i={type:e,name:t,icon:a,inputs:n,outputs:o,x:r,y:c,w:100,h:0,resources:{},connections:[]},s=new Image;return s.src=a,i.icon=s,i.update=function(){let e=this;e.connections=[];let t=ctx.measureText(e.name).actualBoundingBoxAscent;e.h=factory_icon_size+4*factory_padding-t/2,e.header_height=e.h,e.dy=e.y+e.header_height+20,e.inputs.forEach(t=>{e.update_node(t)}),e.outputs.forEach(t=>{e.update_node(t)}),e.calc_connections()},i.draw=function(){let e=this;ctx.beginPath(),ctx.fillStyle="#222233",ctx.fillRect(e.x,e.y,e.w,e.h),ctx.strokeStyle="#444",ctx.strokeRect(e.x,e.y,e.w,e.h),ctx.closePath(),ctx.fillStyle="#fff",ctx.font=factory_font;let t=ctx.measureText(e.name).actualBoundingBoxAscent;ctx.fillText(e.name,e.x+factory_icon_size+3*factory_padding,e.y+(factory_icon_size+2*factory_padding)-t/2),ctx.measureText(e.name).width+factory_font_size+factory_padding>=e.w&&(e.w=ctx.measureText(e.name).width+factory_font_size+4*factory_padding),ctx.beginPath(),ctx.drawImage(e.icon,0,0,e.icon.width,e.icon.height,e.x+factory_padding,e.y+factory_padding,factory_icon_size,factory_icon_size),ctx.closePath(),e.inputs.forEach(t=>{e.draw_node(t)}),e.outputs.forEach(t=>{e.draw_node(t)})},i.update_node=function(e){let t=this,a=("input"==e.type?e.usage_rate:e.production_rate)+(e.unit||"u/s")+" | "+e.name,n=ctx.measureText(a).width+2*e.r+10;n>t.w&&(t.w=n),e.x="input"==e.type?t.x:t.x+t.w,e.y=t.dy,t.dy+=2*e.r+10,t.h+=3*factory_padding+2*e.r,t.resources[e.id]||(t.resources[e.id]=rates[e.id]||{})},i.draw_node=function(e){ctx.beginPath(),ctx.fillStyle=node_colors[e.id],ctx.arc(e.x,e.y,e.r,0,2*Math.PI),ctx.fill(),ctx.closePath();let t=("input"==e.type?e.usage_rate:e.production_rate)+(e.unit||"u/s")+" | "+e.name;"input"==e.type?(ctx.beginPath(),ctx.fillText(t,e.x+2*e.r,e.y+e.r/2),ctx.closePath()):(ctx.beginPath(),ctx.fillText(t,e.x-ctx.measureText(t).width-2*e.r,e.y+e.r/2),ctx.closePath())},i.calc_connections=function(){let e=this,t=e.outputs;t.forEach(t=>{if(t.connected){let a=t.connected;if(a.remove_on_mouse_up&&!mousedown)return t.connected=null,void factories.forEach(e=>{e.inputs.forEach(e=>{(e.id==t.id||e.any)&&hit_rad(e)&&(e.connected&&e.connected.connected==e&&(e.connected.connected=null,t.connected=null,e.connected=null),t.connected=e,e.connected=t)})});let n={},o=t.x>a.x?a:t;n.remote_node=a;let r=(t.x+a.x)/2;if(t==o){let e={x:r,y:t.y},o={x:r,y:a.y};n.x=t.x,n.y=t.y,n.cp1=e,n.cp2=o,n.px=a.x,n.py=a.y}else{let e={x:r,y:a.y},o={x:r,y:t.y};n.x=t.x,n.y=t.y,n.cp1=e,n.cp2=o,n.px=a.x,n.py=a.y}n.strokeStyle=node_colors[t.id],e.connections.push(n)}})},i.add_connection=function(e,t="input",a="tile",n="Empty Connector",o="u",r=0,c=0){let i=this,s={type:t,id:a,name:n,unit:o,production_rate:r,usage_rate:c,r:10,any:"any"==a};i[e].push(s)},i};var water_pump=function(){let e=factory("water_pump","Water Pump");e.add_connection("inputs","input","power","power","kW",0,10),e.add_connection("outputs","output","water","Water","L",100,0),factories.push(e)},solar=function(){let e=factory("solar","Solar Panels");e.add_connection("outputs","output","power","Solar Power","kW",20,0),factories.push(e)},combiner=function(){let e=factory("combiner","Combiner");e.add_connection("outputs","output","any","Any","u",0,0),e.add_connection("inputs","input","any","Any","u",0,0),e.add_connection("inputs","input","any","Any","u",0,0),factories.push(e)};addEventListener("load",()=>{let e=document.querySelectorAll(".create_factory");e.forEach(e=>{e.addEventListener("click",t=>{let a=e.dataset.type;console.log(a),window[a]?window[a]():console.error("Did you forget to make the create function for: ",a)})})});let resources={},loop=function(){t++;var e=ctx.transformedPoint(0,0),a=ctx.transformedPoint(canvas.width,canvas.height);ctx.clearRect(e.x,e.y,a.x-e.x,a.y-e.y),ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#1e1e1e",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.restore(),factories.forEach(e=>{e.update(),ctx.lineWidth=3,e.connections.forEach(e=>{ctx.beginPath(),ctx.moveTo(e.x,e.y),ctx.bezierCurveTo(e.cp1.x,e.cp1.y,e.cp2.x,e.cp2.y,e.px,e.py),ctx.strokeStyle=e.strokeStyle,ctx.stroke(),ctx.closePath()})}),factories.forEach(e=>{e.draw()}),mousedown&&(dragging?dragging.remove_on_mouse_up?(dragging.x=mx,dragging.y=my):(dragging.f.x=Math.round((mx-dragging.diffx)/grid_size)*grid_size,dragging.f.y=Math.round((my-dragging.diffy)/grid_size)*grid_size):factories.forEach(e=>{hit(e)&&(dragging={f:e,diffx:mx-e.x,diffy:my-e.y}),e.outputs.concat(e.inputs).forEach(e=>{if(hit_rad(e)){let t={remove_on_mouse_up:!0,id:e.id,x:mx,y:my};e.connected&&(e.connected.connected=null),e.connected=t,dragging=t}})})),requestAnimationFrame(FPS_LOCK)},wheel_radius=75,wheel_inner_radius=25,context_wheel=[],d=60;for(let e=0;e<360/d;e++)context_wheel.push({name:"add",deg:d,hovering:!1,clicked:!1,shape:[],update:function(){let t=this,a=t.deg/2,n=e*t.deg;t.shape=[[static_mx+Math.cos(d2r(n-a))*wheel_inner_radius,static_my+Math.sin(d2r(n-a))*wheel_inner_radius],[static_mx+Math.cos(d2r(n-a))*(wheel_radius+10),static_my+Math.sin(d2r(n-a))*(wheel_radius+10)],[static_mx+Math.cos(d2r(n+a))*(wheel_radius+10),static_my+Math.sin(d2r(n+a))*(wheel_radius+10)],[static_mx+Math.cos(d2r(n+a))*wheel_inner_radius,static_my+Math.sin(d2r(n+a))*wheel_inner_radius],[static_mx+Math.cos(d2r(n-a))*wheel_inner_radius,static_my+Math.sin(d2r(n-a))*wheel_inner_radius]]},draw:function(){let t=this,a=t.deg/2,n=e*t.deg;t.hovering?ctx.strokeStyle="#fff":ctx.strokeStyle="#5e5e5e",ctx.beginPath(),ctx.moveTo(static_mx+Math.cos(d2r(n-a))*wheel_inner_radius,static_my+Math.sin(d2r(n-a))*wheel_inner_radius),ctx.lineTo(static_mx+Math.cos(d2r(n-a))*wheel_radius,static_my+Math.sin(d2r(n-a))*wheel_radius),ctx.arc(static_mx+Math.cos(d2r(n+a)),static_my+Math.sin(d2r(n+a)),wheel_radius,d2r(n-a),d2r(n+a),!1),ctx.lineTo(static_mx+Math.cos(d2r(n+a))*wheel_inner_radius,static_my+Math.sin(d2r(n+a))*wheel_inner_radius),ctx.lineTo(static_mx+Math.cos(d2r(n-a))*wheel_inner_radius,static_my+Math.sin(d2r(n-a))*wheel_inner_radius),ctx.stroke(),ctx.closePath()}});context_wheel.forEach(e=>{e.x=0,e.y=0});let FPS_LOCK=function(){let e=performance.now(),t=e-then;t>1e3/FPS?(then=e-t%(1e3/FPS),loop()):requestAnimationFrame(FPS_LOCK)};requestAnimationFrame(FPS_LOCK),addEventListener("contextmenu",e=>{e.preventDefault()}),addEventListener("mousedown",e=>{document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none";let t=e.button;switch(mouse_click.x=e.pageX,mouse_click.y=e.pageY,t){case 0:mousedown=!0,middlemousedown=!1,rightmousedown=!1;break;case 1:e.preventDefault(),middlemousedown=!0,mousedown=!1,rightmousedown=!1,lastX=e.offsetX||e.pageX-canvas.offsetLeft,lastY=e.offsetY||e.pageY-canvas.offsetTop,dragStart=ctx.transformedPoint(lastX,lastY),dragged=!1;break;case 2:e.preventDefault(),rightmousedown=!0,middlemousedown=!1,mousedown=!1,static_mx=e.clientX,static_my=e.clientY;break;default:mousedown=!0,mouse_click.x=e.pageX,mouse_click.y=e.pageY}}),addEventListener("mouseup",e=>{e.preventDefault(),dragging=!1,mousedown=!1,rightmousedown=!1,middlemousedown=!1}),addEventListener("mousemove",e=>{e.preventDefault(),e.stopPropagation();let t=ctx.transformedPoint(e.clientX,e.clientY);if(mx=t.x,my=t.y,middlemousedown&&(lastX=e.offsetX||e.pageX-canvas.offsetLeft,lastY=e.offsetY||e.pageY-canvas.offsetTop,dragged=!0,dragStart)){var a=ctx.transformedPoint(lastX,lastY);ctx.translate(a.x-dragStart.x,a.y-dragStart.y)}}),addEventListener("mouseout",e=>{e.preventDefault(),e.stopPropagation(),mousedown=!1,rightmousedown=!1,middlemousedown=!1,dragStart=null}),addEventListener("wheel",e=>{var t=e.wheelDelta?e.wheelDelta/40:e.detail?-e.detail:0;return t&&zoom(t),!1});let zoom=function(e){var t=ctx.transformedPoint(canvas.width/2,canvas.height/2);ctx.translate(t.x,t.y),scale=Math.pow(scaleFactor,e),ctx.scale(scale,scale),ctx.translate(-t.x,-t.y)},hit=function(e){let t=e.x,a=e.y;e.w,e.h;return!(mx<t)&&(!(mx>t+e.w)&&(!(my<a)&&!(my>a+e.h)))},hit_rad=function(e){let t=10,a=t*e.r+e.r*e.r,n=Math.abs(e.x-mx),o=Math.abs(e.y-my),r=n*n+o*o;return r<a};