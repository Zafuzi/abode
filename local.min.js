let mousedown=!1,mx=0,my=0,mouse_click={x:0,y:0},canvas=document.querySelector("#game_canvas"),ctx=canvas.getContext("2d");canvas.width=window.innerWidth,canvas.height=window.innerHeight,ctx.font="18px sans-serif";let node_colors={power:"#fff3a6",oxygen:"#ffa6a6",methane:"#a6fffe",water:"#a6caff",steel:"#d3d7de",grass:"#a6ffaf"},connections=[],factories=[];class Factory{constructor(e,t,n,a,c,o){this.name=e,this.x=t,this.y=n,this.inputs=a,this.outputs=c,this.color=o,this.w=250;let i=Object.keys(a).length>Object.keys(c).length?Object.keys(a).length:Object.keys(c).length;this.h=45+33*i,this.canvas=document.createElement("canvas"),this.canvas.width=this.w+35,this.canvas.height=this.h+3,this.ctx=this.canvas.getContext("2d"),this.ctx.font="18px sans-serif",this.ctx.imageSmoothingEnabled=!0}init(){let e=this,t=15,n=57;e.ctx.clearRect(0,0,e.canvas.w,e.canvas.h),e.ctx.beginPath(),e.ctx.fillStyle="#333",e.ctx.fillRect(t,0,e.w,e.h),e.ctx.strokeStyle="#ddd",e.ctx.lineWidth=2,e.ctx.strokeRect(t,0,e.w,e.h),e.ctx.closePath(),Object.keys(e.inputs).forEach(a=>{let c=e.inputs[a];console.log(e.name," | input:",a),c.x=t,c.y=n,c.name=a,c.parent=e,e.ctx.beginPath(),e.ctx.fillStyle=node_colors[c.name],e.ctx.arc(c.x,c.y,10,0,2*Math.PI),e.ctx.fill(),e.ctx.closePath(),e.ctx.beginPath(),e.ctx.fillText(c.name,c.x+18,c.y+5),e.ctx.closePath(),n+=25}),t=15+e.w,n=23,Object.keys(e.outputs).forEach(a=>{console.log(e.name," | output:",a);let c=e.outputs[a];c.x=t,c.y=n,c.name=a,c.parent=e,e.ctx.beginPath(),e.ctx.fillStyle=node_colors[c.name],e.ctx.arc(c.x,c.y,10,0,2*Math.PI),e.ctx.fill(),e.ctx.closePath(),e.ctx.beginPath(),e.ctx.fillText(c.name,c.x-e.ctx.measureText(c.name).width-18,c.y+5),e.ctx.closePath(),c.connected||(c.connected=[]),n+=25}),e.ctx.beginPath(),e.ctx.fillStyle="#fff",e.ctx.fillText(e.name,24,27),e.ctx.closePath(),console.log(""),factories.push(e)}update(){this.connections=[],this.calc_connections()}calc_connections(){let e=this,t=15+e.w,n=23;Object.keys(e.outputs).forEach(a=>{let c=e.outputs[a];c.x=t,c.y=n,c.name=a,c.parent=e,c.connected||(c.connected=[]),c.connected.length>0&&c.connected.forEach(t=>{let n={},a=e.x+c.x>t.x+t.parent.x?t:c;n.remote_node=t,n.parent=e;let o=(e.x+c.x+t.parent.x+t.x)/2;if(c==a){let a={x:o,y:c.y+e.y},i={x:o,y:t.parent.y+t.y};n.x=c.x,n.y=c.y,n.cp1=a,n.cp2=i,n.px=t.x,n.py=t.y}else{let a={x:o,y:t.parent.y+t.y},i={x:o,y:e.y+c.y};n.x=c.x,n.y=c.y,n.cp1=a,n.cp2=i,n.px=t.x,n.py=t.y}var i=ctx.createLinearGradient(c.x,c.y,t.x,t.y);i.addColorStop(0,node_colors[c.name]),i.addColorStop(1,node_colors[t.name]),n.strokeStyle=i,e.connections.push(n)}),n+=25})}}let SolarPanel=new Factory("Solar Panel",100,300,{},{power:{}},"#333");SolarPanel.init();let OxygenMine=new Factory("Oxygen Mine",400,300,{power:{},water:{}},{oxygen:{}},"#333");OxygenMine.init();let RainCollector=new Factory("Rain Collector",100,400,{},{water:{}},"#333");RainCollector.init();let GrassField=new Factory("GrassField",100,500,{},{grass:{}},"#333");GrassField.init();let MethaneMine=new Factory("Farting Cows",400,450,{grass:{},water:{}},{methane:{}},"#333");MethaneMine.init();let SteelMine=new Factory("Steel Mine",800,250,{oxygen:{},methane:{}},{steel:{}},"#333");SteelMine.init(),SolarPanel.outputs.power.connected.push(OxygenMine.inputs.power),OxygenMine.outputs.oxygen.connected.push(SteelMine.inputs.oxygen),RainCollector.outputs.water.connected.push(OxygenMine.inputs.water,MethaneMine.inputs.water),GrassField.outputs.grass.connected.push(MethaneMine.inputs.grass),MethaneMine.outputs.methane.connected.push(SteelMine.inputs.methane);let dragging,then=performance.now(),FPS=120,t=0,FPS_LOCK=function(){let e=performance.now(),t=e-then;t>1e3/FPS?(then=e-t%(1e3/FPS),loop()):requestAnimationFrame(FPS_LOCK)},hit=function(e=Factory){let t=e.x,n=e.y;e.w,e.h;return!(mx<t)&&(!(mx>t+e.w)&&(!(my<n)&&!(my>n+e.h)))};ctx.imageSmoothingEnabled=!0;let loop=function(){if(t++,ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),connections=[],factories.forEach(e=>{e.update(),e.connections.forEach(e=>{ctx.beginPath(),ctx.moveTo(e.parent.x+e.x,e.parent.y+e.y),ctx.bezierCurveTo(e.cp1.x,e.cp1.y,e.cp2.x,e.cp2.y,e.remote_node.parent.x+e.px,e.remote_node.parent.y+e.py),ctx.strokeStyle=e.strokeStyle,ctx.stroke(),ctx.closePath()})}),factories.forEach(e=>{ctx.drawImage(e.canvas,e.x,e.y)}),mousedown)if(dragging)dragging.f.x=mx-dragging.diffx,dragging.f.y=my-dragging.diffy;else for(let e=0;e<factories.length;e++){let t=factories[e];hit(t)&&(dragging={f:t,diffx:mx-t.x,diffy:my-t.y})}requestAnimationFrame(FPS_LOCK)};requestAnimationFrame(FPS_LOCK),addEventListener("mousedown",e=>{mousedown=!0,mouse_click.x=e.pageX,mouse_click.y=e.pageY}),addEventListener("mouseup",e=>{mousedown=!1,dragging=!1}),addEventListener("mousemove",e=>{mx=e.pageX,my=e.pageY});