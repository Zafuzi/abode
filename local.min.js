function trackTransforms(t){var e=document.createElementNS("http://www.w3.org/2000/svg","svg"),a=e.createSVGMatrix();t.getTransform=function(){return a};var r=[],n=t.save;t.save=function(){return r.push(a.translate(0,0)),n.call(t)};var o=t.restore;t.restore=function(){return a=r.pop(),o.call(t)};var s=t.scale;t.scale=function(e,r){return a=a.scaleNonUniform(e,r),s.call(t,e,r)};var c=t.rotate;t.rotate=function(e){return a=a.rotate(180*e/Math.PI),c.call(t,e)};var i=t.translate;t.translate=function(e,r){return a=a.translate(e,r),i.call(t,e,r)};var d=t.transform;t.transform=function(r,n,o,s,c,i){var l=e.createSVGMatrix();return l.a=r,l.b=n,l.c=o,l.d=s,l.e=c,l.f=i,a=a.multiply(l),d.call(t,r,n,o,s,c,i)};var l=t.setTransform;t.setTransform=function(e,r,n,o,s,c){return a.a=e,a.b=r,a.c=n,a.d=o,a.e=s,a.f=c,l.call(t,e,r,n,o,s,c)};var m=e.createSVGPoint();t.transformedPoint=function(t,e){return m.x=t,m.y=e,m.matrixTransform(a.inverse())}}let mousedown=!1,rightmousedown=!1,middlemousedown=!1,mx=0,my=0,mouse_click={x:0,y:0},lastX=0,lastY=0,dragStart=null,dragged=!1,scaleFactor=1.025,canvas=document.querySelector("#game_canvas"),ctx=canvas.getContext("2d");ctx.imageSmoothingEnabled=!0,ctx.lineWidth=3,canvas.width=window.innerWidth,canvas.height=window.innerHeight,trackTransforms(ctx),lastX=canvas.width/2,lastY=canvas.height/2;let dragging,connections=[],factories=[],grid_size=2,font_size=18,then=performance.now(),FPS=100,t=0;new Factory(FactoryTypes.steel,800,300),new Factory(FactoryTypes.iron,400,200),new Factory(FactoryTypes.carbon,400,350),new Factory(FactoryTypes.oxygen,400,450),new Factory(FactoryTypes.solar,50,450),new Factory(FactoryTypes.water,50,550),new Factory(FactoryTypes.rocket,1100,300);let loop=function(){t++;var e=ctx.transformedPoint(0,0),a=ctx.transformedPoint(canvas.width,canvas.height);if(ctx.clearRect(e.x,e.y,a.x-e.x,a.y-e.y),ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.restore(),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),connections=[],factories.forEach(t=>{t.update(),t.connections.forEach(t=>{ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.bezierCurveTo(t.cp1.x,t.cp1.y,t.cp2.x,t.cp2.y,t.px,t.py),ctx.strokeStyle=t.strokeStyle,ctx.stroke(),ctx.closePath()})}),factories.forEach(t=>{t.draw()}),mousedown)if(dragging)dragging.name?(dragging.x=mx,dragging.y=my):(dragging.f.x=Math.round((mx-dragging.diffx)/grid_size)*grid_size,dragging.f.y=Math.round((my-dragging.diffy)/grid_size)*grid_size);else for(let t=0;t<factories.length;t++){let e=factories[t];hit(e)&&(dragging={f:e,diffx:mx-e.x,diffy:my-e.y}),Object.keys(e.outputs).forEach(t=>{let a=e.outputs[t];if(hit_rad({x:a.x,y:a.y,r:a.r})){let r={remove_on_mouse_up:!0,name:a.name,x:mx,y:my,parent:{name:"mouse",x:mx,y:my}};e.outputs[t].connected=r,dragging=r}})}requestAnimationFrame(FPS_LOCK)},FPS_LOCK=function(){let t=performance.now(),e=t-then;e>1e3/FPS?(then=t-e%(1e3/FPS),loop()):requestAnimationFrame(FPS_LOCK)};requestAnimationFrame(FPS_LOCK),addEventListener("contextmenu",t=>{t.preventDefault()}),addEventListener("mousedown",t=>{document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none";let e=t.button;switch(t.preventDefault(),mouse_click.x=t.pageX,mouse_click.y=t.pageY,e){case 0:mousedown=!0;break;case 1:middlemousedown=!0,lastX=t.offsetX||t.pageX-canvas.offsetLeft,lastY=t.offsetY||t.pageY-canvas.offsetTop,dragStart=ctx.transformedPoint(lastX,lastY),dragged=!1;break;case 2:rightmousedown=!0;break;default:mousedown=!0,mouse_click.x=t.pageX,mouse_click.y=t.pageY}}),addEventListener("mouseup",t=>{let e=t.button;switch(t.preventDefault(),mousedown=!1,dragging=!1,e){case 0:mousedown=!1;break;case 1:middlemousedown=!1,dragStart=null;break;case 2:rightmousedown=!1;break;default:mousedown=!1}}),addEventListener("mousemove",t=>{t.preventDefault(),t.stopPropagation();let e=ctx.transformedPoint(t.clientX,t.clientY);if(mx=e.x,my=e.y,middlemousedown&&(lastX=t.offsetX||t.pageX-canvas.offsetLeft,lastY=t.offsetY||t.pageY-canvas.offsetTop,dragged=!0,dragStart)){var a=ctx.transformedPoint(lastX,lastY);ctx.translate(a.x-dragStart.x,a.y-dragStart.y)}}),addEventListener("mouseout",t=>{t.preventDefault(),t.stopPropagation(),mousedown=!1,rightmousedown=!1,middlemousedown=!1,dragStart=null});let zoom=function(t){var e=ctx.transformedPoint(canvas.width/2,canvas.height/2);ctx.translate(e.x,e.y);var a=Math.pow(scaleFactor,t);ctx.scale(a,a),ctx.translate(-e.x,-e.y)};addEventListener("wheel",t=>{var e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;return e&&zoom(e),!1});let hit=function(t=Factory){let e=t.x,a=t.y;t.w,t.h;return!(mx<e)&&(!(mx>e+t.w)&&(!(my<a)&&!(my>a+t.h)))},hit_rad=function(t){let e=10,a=e*t.r+t.r*t.r,r=Math.abs(t.x-mx),n=Math.abs(t.y-my),o=r*r+n*n;return o<a};