let Icons={credit:"images/tile.png",steel:"images/steel.png",oxygen:"images/oxygen.png",methane:"images/methane.png",rocket:"images/rocket.png",station:"images/station.png",power:"images/power.png",hydrogen:"images/tile.png",water:"images/water.png",carbon:"images/tile.png",grass:"images/tile.png",iron:"images/tile.png",slag:"images/tile.png",trees:"images/tile.png",silicate:"images/tile.png"},node_colors={power:"#fff3a6",oxygen:"#ffa6a6",hydrogen:"#fff",methane:"#a6fffe",water:"#a6caff",steel:"#999",grass:"#a6ffaf",carbon:"#58637a",slag:"#c9bbab",iron:"#ba7254",rocket:"#ff99e6",silicates:"#b6c9a5",trees:"#ffffff",carbon_dioxide:"#ffffff",food:"#ffffff"},FactoryTypes={solar:{name:"Solar Panels",icon:Icons.power,inputs:{},outputs:{power:{}}},water:{name:"Big Lake of Fresh Water",icon:Icons.water,inputs:{},outputs:{water:{}}},oxygen:{name:"Oxygen Electrolysis Chamber",icon:Icons.oxygen,inputs:{power:{},water:{}},outputs:{hydrogen:{},oxygen:{}}},carbon:{name:"Charcoal Hut",icon:Icons.carbon,inputs:{trees:{}},outputs:{carbon:{},carbon_dioxide:{}}},iron:{name:"Iron Mine",icon:Icons.iron,inputs:{},outputs:{iron:{},silicates:{}}},steel:{name:"Steel Production Facility",icon:Icons.steel,inputs:{iron:{},carbon:{},oxygen:{}},outputs:{steel:{},slag:{}}},rocket:{name:"Rocket Fabricator",icon:Icons.rocket,inputs:{steel:{},methane:{},oxygen:{},power:{}},outputs:{rocket:{}}},trees:{name:"Synthetic Forest",icon:Icons.trees,inputs:{power:{},water:{}},outputs:{carbon:{},carbon_dioxide:{},food:{},trees:{}}}};class Factory{constructor(e,t,n){this.name=e.name,this.inputs=e.inputs,this.outputs=e.outputs;let o=new Image;o.src=e.icon,this.icon=o,this.x=t,this.y=n,this.w=100,this.node_radius=5,this.h=this.icon.height+40;let s=Object.keys(this.inputs).length>Object.keys(this.outputs).length?Object.keys(this.inputs).length:Object.keys(this.outputs).length;this.h+=s*(2*this.node_radius+5),this.h+=10,factories.push(this)}update(){this.connections=[],this.calc_connections()}draw(){let e=this,t=e.x,n=e.y;ctx.beginPath(),ctx.fillStyle="#223333",ctx.fillRect(t,n,e.w,e.h),ctx.strokeStyle="#444",ctx.strokeRect(t,n,e.w,e.h),ctx.closePath(),t=e.x,n=e.y+e.icon.height-2*e.node_radius-5,Object.keys(e.inputs).forEach(o=>{let s=e.inputs[o];s.name||(s.name=o,s.parent=e,s.r=e.node_radius),s.x=t,s.y=n,ctx.beginPath(),ctx.fillStyle=node_colors[s.name],ctx.arc(s.x,s.y,e.node_radius,0,2*Math.PI),ctx.fill(),ctx.closePath(),ctx.beginPath(),ctx.fillText(s.name,s.x+font_size,s.y+5),ctx.closePath(),n+=2*e.node_radius+5}),t=e.x+e.w,n=e.y+2*e.node_radius+10,Object.keys(e.outputs).forEach(o=>{let s=e.outputs[o];s.x=t,s.y=n,s.name=o,s.parent=e,s.r=e.node_radius,ctx.beginPath(),ctx.fillStyle=node_colors[s.name],ctx.arc(s.x,s.y,e.node_radius,0,2*Math.PI),ctx.fill(),ctx.closePath(),ctx.beginPath(),ctx.fillText(s.name,s.x-ctx.measureText(s.name).width-2*e.node_radius,s.y+e.node_radius/2),ctx.closePath(),n+=2*e.node_radius+5}),ctx.beginPath(),ctx.drawImage(e.icon,0,0,e.icon.width,e.icon.height,e.x+5,e.y+10,18,18),ctx.closePath()}calc_connections(){let e=this,t=e.x+e.w,n=e.y+2*e.node_radius+10;Object.keys(e.outputs).forEach(o=>{let s=e.outputs[o];if(s.name||(s.x=t,s.y=n,s.name=o,s.parent=e,s.r=e.node_radius),s.connected){let t=s.connected;if(t.remove_on_mouse_up&&!mousedown)return s.connected=null,void factories.forEach(n=>{Object.keys(n.inputs).forEach(o=>{let i=n.inputs[o];hit_rad({x:i.x,y:i.y,r:e.node_radius})&&o==t.name&&(i.connected&&(i.connected.connected=null),s.connected=i,i.connected=s)})});if(!t.parent)return;let n={},o=s.x>t.x?t:s;n.remote_node=t,n.parent=e;let i=(s.x+t.x)/2;if(s==o){let e={x:i,y:s.y},o={x:i,y:t.y};n.x=s.x,n.y=s.y,n.cp1=e,n.cp2=o,n.px=t.x,n.py=t.y}else{let e={x:i,y:t.y},o={x:i,y:s.y};n.x=s.x,n.y=s.y,n.cp1=e,n.cp2=o,n.px=t.x,n.py=t.y}n.strokeStyle=node_colors[s.name],e.connections.push(n)}n+=2*e.node_radius+5})}}